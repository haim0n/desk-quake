<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Desk-Quake</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
            transition: background-color 0.1s;
        }

        body.shaking {
            background: #8b0000;
            animation: flash 0.2s ease-in-out infinite alternate;
        }

        @keyframes flash {
            from { background: #8b0000; }
            to { background: #ff4444; }
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #fff;
        }

        .card {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .status-section {
            text-align: center;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
        }

        .status-dot.monitoring {
            background: #00cc66;
            animation: pulse 1.5s infinite;
        }

        .status-dot.shaking {
            background: #ff4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .magnitude-display {
            margin-top: 10px;
        }

        .magnitude-bar {
            height: 20px;
            background: #0f3460;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .magnitude-fill {
            height: 100%;
            background: linear-gradient(90deg, #00cc66, #ffcc00, #ff4444);
            border-radius: 10px;
            transition: width 0.1s;
            width: 0%;
        }

        .magnitude-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .threshold-section label {
            display: block;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #aaa;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-container input[type="range"] {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: #0f3460;
            border-radius: 4px;
            outline: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #4a90d9;
            border-radius: 50%;
            cursor: pointer;
        }

        .threshold-value {
            font-size: 1.2rem;
            font-weight: bold;
            min-width: 60px;
            text-align: right;
        }

        .start-btn {
            width: 100%;
            padding: 18px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .start-btn.start {
            background: #00cc66;
            color: #fff;
        }

        .start-btn.stop {
            background: #ff4444;
            color: #fff;
        }

        .start-btn:active {
            transform: scale(0.98);
        }

        .history-section h2 {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 12px;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #0f3460;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .history-item .time {
            color: #aaa;
        }

        .history-item .magnitude {
            font-weight: bold;
            color: #ff6b6b;
        }

        .empty-history {
            color: #666;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }

        .error-message {
            background: #ff4444;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DESK-QUAKE</h1>

        <div id="error" class="error-message" style="display: none;"></div>

        <div class="card status-section">
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Ready</span>
            </div>
            <div class="magnitude-display">
                <div class="magnitude-bar">
                    <div class="magnitude-fill" id="magnitudeFill"></div>
                </div>
                <div class="magnitude-value"><span id="magnitudeValue">0.0</span> m/s²</div>
            </div>
        </div>

        <div class="card threshold-section">
            <label>Shake Threshold</label>
            <div class="slider-container">
                <input type="range" id="thresholdSlider" min="0.0" max="10" value="0.3" step="0.1">
                <span class="threshold-value"><span id="thresholdValue">0.2</span> m/s²</span>
            </div>
        </div>

        <button class="start-btn start" id="startBtn">START MONITORING</button>

        <div class="card history-section">
            <h2>Shake History</h2>
            <div class="history-list" id="historyList">
                <div class="empty-history">No shakes detected yet</div>
            </div>
        </div>
    </div>

    <script>
        // State
        let isMonitoring = false;
        let threshold = 2;
        let lastAlertTime = 0;
        const alertCooldown = 2000; // 2 seconds between alerts
        const historyMax = 20;
        const history = [];
        let audioContext = null;

        // DOM Elements
        const startBtn = document.getElementById('startBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const magnitudeFill = document.getElementById('magnitudeFill');
        const magnitudeValue = document.getElementById('magnitudeValue');
        const thresholdSlider = document.getElementById('thresholdSlider');
        const thresholdValueEl = document.getElementById('thresholdValue');
        const historyList = document.getElementById('historyList');
        const errorDiv = document.getElementById('error');

        // Initialize Audio Context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // Play alert sound
        function playAlertSound() {
            if (!audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 880; // A5 note
            oscillator.type = 'square';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // Update threshold display
        thresholdSlider.addEventListener('input', (e) => {
            threshold = parseFloat(e.target.value);
            thresholdValueEl.textContent = threshold;
        });

        // Handle device motion
        function handleMotion(event) {
            if (!isMonitoring) return;

            const acc = event.accelerationIncludingGravity;
            if (!acc || acc.x === null) return;

            // Calculate horizontal magnitude only (X and Y axes)
            // Z axis is ignored since device lies flat on desk
            const magnitude = Math.sqrt(acc.x * acc.x + acc.y * acc.y);

            // No gravity subtraction needed - gravity acts on Z axis when flat
            const adjustedMagnitude = magnitude;

            // Update display
            magnitudeValue.textContent = adjustedMagnitude.toFixed(1);
            const fillPercent = Math.min((adjustedMagnitude / 10) * 100, 100);
            magnitudeFill.style.width = fillPercent + '%';

            // Check threshold
            const now = Date.now();
            if (adjustedMagnitude > threshold && (now - lastAlertTime) > alertCooldown) {
                triggerAlert(adjustedMagnitude);
                lastAlertTime = now;
            }
        }

        // Trigger alert
        function triggerAlert(magnitude) {
            // Visual alert
            document.body.classList.add('shaking');
            statusDot.classList.add('shaking');
            statusText.textContent = 'SHAKING!';

            // Sound alert
            playAlertSound();

            // Add to history
            addToHistory(magnitude);

            // Reset after 1 second
            setTimeout(() => {
                document.body.classList.remove('shaking');
                statusDot.classList.remove('shaking');
                if (isMonitoring) {
                    statusText.textContent = 'Monitoring';
                }
            }, 1000);
        }

        // Add shake event to history
        function addToHistory(magnitude) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false });

            history.unshift({
                time: timeStr,
                magnitude: magnitude.toFixed(1)
            });

            if (history.length > historyMax) {
                history.pop();
            }

            renderHistory();
        }

        // Render history list
        function renderHistory() {
            if (history.length === 0) {
                historyList.innerHTML = '<div class="empty-history">No shakes detected yet</div>';
                return;
            }

            historyList.innerHTML = history.map(item => `
                <div class="history-item">
                    <span class="time">${item.time}</span>
                    <span class="magnitude">${item.magnitude} m/s²</span>
                </div>
            `).join('');
        }

        // Start monitoring
        async function startMonitoring() {
            try {
                // Initialize audio on user interaction
                initAudio();

                // Request permission for DeviceMotion (iOS 13+)
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    const permission = await DeviceMotionEvent.requestPermission();
                    if (permission !== 'granted') {
                        showError('Motion sensor permission denied');
                        return;
                    }
                }

                // Check if DeviceMotion is supported
                if (!window.DeviceMotionEvent) {
                    showError('Device motion not supported on this device');
                    return;
                }

                window.addEventListener('devicemotion', handleMotion);
                isMonitoring = true;

                // Update UI
                startBtn.textContent = 'STOP MONITORING';
                startBtn.classList.remove('start');
                startBtn.classList.add('stop');
                statusDot.classList.add('monitoring');
                statusText.textContent = 'Monitoring';
                errorDiv.style.display = 'none';

            } catch (err) {
                showError('Failed to start motion detection: ' + err.message);
            }
        }

        // Stop monitoring
        function stopMonitoring() {
            window.removeEventListener('devicemotion', handleMotion);
            isMonitoring = false;

            // Update UI
            startBtn.textContent = 'START MONITORING';
            startBtn.classList.remove('stop');
            startBtn.classList.add('start');
            statusDot.classList.remove('monitoring', 'shaking');
            statusText.textContent = 'Stopped';
            document.body.classList.remove('shaking');
        }

        // Show error message
        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Toggle monitoring
        startBtn.addEventListener('click', () => {
            if (isMonitoring) {
                stopMonitoring();
            } else {
                startMonitoring();
            }
        });
    </script>
</body>
</html>
